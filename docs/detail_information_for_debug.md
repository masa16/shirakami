# 詳細情報の出力に関する資料

## 2023/2/3, tanabe

- 本資料の目的

  - 問題視される事象が発生し、事象を特定のシナリオで再現できないとき、 shirakami の状態を出力して論理的な検証を行うことでデバッグをサポートする需要がある。本資料ではデバッグをサポートできるような詳細情報としてどのようなものがあるか、その出力方法等に関してまとめる。

- 基本方針

  - 既存のデータベース設定ファイル情報の上位レイヤーから下位レイヤーに対する引き渡しによって情報の出力を切り替える。
  - 現状は環境変数 SHIRAKAMI_DETAIL_INFO=1 が設定されていたら、上記の情報引き渡しなく出力が有効になる。
  - 現状は google logging の DVLOG(50) で出力される。今後情報の種類や量が充実したら、SHIRAKAMI_DETAIL_INFO の数字を調整することで更に流量を調整可能なようにする。

- （現状の）使い方
  - 情報を生成する：プログラムの実行前に環境変数 SHIRAKAMI_DETAIL_INFO=1 を設定する。
  - 情報を生成しない：プログラムの実行前に環境変数 SHIRAKAMI_DETAIL_INFO=0 を設定する。

- 詳細情報
  - 全てのロギングに必ず付与する情報
    - worker id
    - 特定のプレフィックス： "/:shirakami:detail_info:"
  - 情報一覧
    - ロック待ちの前後と対象のキー文字列
    - LTX が開始したときのトランザクションオプション内容: token, ltx id.
    - LTX がコミット処理をリクエストしたときの待つ対象の ltx id.