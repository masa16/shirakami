# 診断情報の出力

## 診断情報とは
ストール時等において、トランザクション実行エンジンの状態を表現する情報。

## API
void print_diagnostics(std::ostream&)

## 現状の制約
- ユーザー側が shirakami に対して何も関数呼び出しを行っていないか、行ってから長時間経過している（関数呼び出しを行わない時間が長時間経っている）ときに利用可能である。
  - ストール時に利用することを前提としているため、緻密な並行プログラミングを実施していないため、不正なメモリ参照等が発生する懸念がある。
- ログに出る worker は必ずトランザクションを処理中であり、トランザクションを開始してからコミット・アボートが確定していない状態である。

## 現状出力している情報
- print_diagnostics の前後で "/:shirakami print diagnostics start", "/:shirakami print diagnostics end" を出力する。
- トランザクションが開始されており、CC としてコミットされていない全てのトランザクション(*1)に関する情報
  - 用途：ストールしているトランザクションは終了されていないトランザクションであると仮定し、上記を分析のため出力する。
- ワーカーのID (Token) と、それが紐づいている TX の universal identifier.
  - TX の universal identifier は先頭が TID- であり、続いて 16 進数 16 桁の英字が小文字で表現され、合わせて 20 桁の文字列とする。
  - 用途
    - universal identifier(TID) : SQL実行エンジンと連携して動作させたときに、全レイヤーで統一の識別子が望まれているため。
    - Token : ストール系のほとんどの問題は並行Txによるものであると仮定し、並行するトランザクションを識別するため。print diagnostics によって出力された情報単体ではこれは意味をなさないが、 shirakami 開発者が print diagnostic を用いてテスト・開発を行う際に有用である。なぜなら shirakami の各 api はほとんど Token を含み、関連付けした分析が有用である。
  - 出力例
    - Token: `==token: 0x5641deb08d80, start information`
    - TID: `TID: TID-00000000000000000000000000000002`
- 各ワーカースレッドが処理しているトランザクションの種別
  - そのトランザクションが `SHORT`, `LONG`, `READ_ONLY` のいずれで実行されているかを示す。
  - 出力例: `tx mode: SHORT`
  - SHORT: Silo CC をベースとして動作するトランザクションモードであり、 OCC と呼ばれることがある。LONG: yatsumine CC をベースとして動作するトランザクションモードである。 READ_ONLY: 並行TXに阻害されえない読み込み専用のトランザクションモードである。
- 各ワーカースレッドが処理しているトランザクションの状態
  - 用途：　トランザクションが開始から終了にかけてどのような段階でストールしているかを見極めるため。
  - 出力例
    - 1. 開始要求を受け付け、開始待ち合わせ中: `state: WAITING_START`
    - 2. ユーザー操作受付中: `state: STARTED`
    - 3. コミットを受諾し、コミット条件を待ち合わせ中: `state: WAITING_CC_COMMIT`
- (*1) の数
  - 用途：ログを分析している際に、print diagnostic 関数が認識しているトランザクション数と分析者が認識しているトランザクション数が一致しているか確認することを可能にするため。これにより、分析者による見落としを防ぐ一助とする。
  - 出力例
    - `number of running tx: 1`

## これから出力するかもしれない情報
  - 各種オペレーティング中 (tx_begin, DML, commit / abort)
    - 用途：各トランザクションの状態をより細粒度で分析するため。
  - some lock waiting
    - 用途：ログから待ちに関する関係を整理し、非論理的な待ちが発生していないかを確認し、デバッグを補助する。
  - index tree traversing
    - 用途：インデックスで stall しているかどうかを疑うべきか判断するための情報。
  - (read / write / node / write preserve) set
    - 用途：ログから読み書きに関する衝突関係を整理し、非論理的な待ちや衝突が発生していないかを確認し、デバッグを補助する。
- 上記トランザクションがLTXモードであるとき、待機対象の LTX
  - 用途：待機されているおおもとのLTXがストールの元凶になりうる。問題の原因分析を補助するため。
  - 現状: コミットリクエストの時点で詳細情報として既に出力している。その Token と診断情報で出力された Token を一致するように検索すれば待機対象のLTXが判明する。診断情報とワーカースレッド・ワーカーからコミットリクエストを受けて処理を代行するデーモンスレッドの三者による排他制御がまだ導入できていないため、ログを照らし合わせれば分かるという状態である。